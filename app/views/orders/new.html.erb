<div class="container mt-4">
  <h1 class="title is-2">Zakup biletu</h1>

  <div class="box">
    <h2 class="title is-4"><%= event.name %></h2>
    <p class="subtitle is-6"><%= event.date.strftime("%d.%m.%Y, %H:%M") %> | <%= event.place %></p>
    <p><strong>Cena biletu:</strong> <%= number_to_currency(ticket_batch.price, unit: "zł", format: "%n %u") %></p>
    <p><strong>Dostępne bilety:</strong> <%= ticket_batch.available_tickets %></p>
  </div>

  <%= form_with(model: order, url: orders_path(ticket_batch_id: ticket_batch.id), local: true) do |f| %>
    <% if order.errors.any? %>
      <div class="notification is-danger">
        <h2><%= pluralize(order.errors.count, "error") %> prohibited this order from being saved:</h2>
        <ul>
          <% order.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="field">
      <%= f.label :quantity, "Liczba biletów", class: "label" %>
      <div class="control">
        <%= f.number_field :quantity, min: 1, max: ticket_batch.available_tickets, value: 1, class: "input", data: { action: "change->order#updateTotal" } %>
      </div>
    </div>

    <div class="notification is-primary">
      <p><strong>Całkowita kwota do zapłaty:</strong> <span id="total-price"><%= number_to_currency(ticket_batch.price, unit: "zł", format: "%n %u") %></span></p>
    </div>

    <% if user_signed_in? || admin_signed_in? %>
      <div class="box">
        <h3 class="title is-5">Dane osobowe</h3>
        <div class="content">
          <% if user_signed_in? %>
            <p><strong>Email:</strong> <%= current_user.email %></p>
            <p><strong>Imię:</strong> <%= current_user.first_name %></p>
            <p><strong>Nazwisko:</strong> <%= current_user.last_name %></p>
            <p class="notification is-info is-light">
              Bilety zostaną przypisane do Twojego konta.<br>
              Jeżeli któreś z tych danych się nie zgadzają, możesz zaktualizować swoje dane w
              <a href="<%= users_dashboard_path %>">Panelu Użytkownika</a>.
            </p>
          <% elsif admin_signed_in? %>
            <p><strong>Email:</strong> <%= current_admin.email %></p>
            <p><strong>Imię:</strong> <%= current_admin.first_name %></p>
            <p><strong>Nazwisko:</strong> <%= current_admin.last_name %></p>
            <p class="notification is-info is-light">
              Bilety zostaną przypisane do Twojego konta administratora.<br>
              Jeżeli któreś z tych danych się nie zgadzają, możesz zaktualizować swoje dane w
              <a href="<%= admins_dashboard_path %>">Panelu Administratora</a>.
            </p>
          <% end %>
        </div>
      </div>
    <% else %>
      <!-- Dla niezalogowanych użytkowników, pokaż dane do wprowadzenia -->
      <div class="box">
        <h3 class="title is-5">Dane osobowe</h3>

        <div class="notification is-info is-light mb-4">
          <div class="columns is-vcentered">
            <div class="column">
              <p>Masz już konto? Zaloguj się, aby szybciej dokończyć zakup.</p>
            </div>
            <div class="column is-narrow">
              <a href="<%= new_user_session_path %>" class="button is-primary">Zaloguj się</a>
            </div>
          </div>
        </div>

        <div class="field">
          <label class="label">Email</label>
          <div class="control">
            <input type="email" name="guest_email" class="input" required>
          </div>
        </div>

        <div class="field">
          <label class="label">Imię</label>
          <div class="control">
            <input type="text" name="guest_first_name" class="input" required>
          </div>
        </div>

        <div class="field">
          <label class="label">Nazwisko</label>
          <div class="control">
            <input type="text" name="guest_last_name" class="input" required>
          </div>
        </div>

        <div class="field">
          <label class="label">Hasło</label>
          <div class="control">
            <input type="password" name="guest_password" class="input" required>
          </div>
        </div>

        <div class="field">
          <label class="label">Potwierdź hasło</label>
          <div class="control">
            <input type="password" name="guest_password_confirmation" class="input" required>
          </div>
          <p class="help">Hasło pozwoli Ci później na dostęp do Twoich biletów i historii zamówień</p>
        </div>

        <p class="notification is-info is-light">
          Na podstawie podanych danych zostanie utworzone konto użytkownika,
          a wszystkie bilety będą przypisane do tego konta.
        </p>
      </div>
    <% end %>

      <div class="field">
        <div class="control">
          <%= f.submit "Potwierdzam zakup", class: "button is-primary is-large" %>
        </div>
      </div>
    <% end %>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.tabs a');
    tabs.forEach(tab => {
      tab.addEventListener('click', function(e) {
        e.preventDefault();

        tabs.forEach(t => t.parentElement.classList.remove('is-active'));
        this.parentElement.classList.add('is-active');

        const targetId = this.getAttribute('data-target');
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = 'none';
        });
        document.getElementById(targetId).style.display = 'block';
      });
    });

    const quantityInput = document.querySelector('input[name="order[quantity]"]');
    const totalPrice = document.getElementById('total-price');
    const unitPrice = <%= ticket_batch.price %>;

    quantityInput.addEventListener('change', function() {
      const quantity = parseInt(this.value);
      if (quantity > 0) {
        const price = (quantity * unitPrice).toFixed(2);
        totalPrice.textContent = price + ' zł';
      }
    });
  });
</script>
