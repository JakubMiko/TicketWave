<%# app/views/orders/new.html.erb %>
<div class="container mt-4">
  <h1 class="title is-2">Zakup biletu</h1>

  <div class="box">
    <h2 class="title is-4"><%= event.name %></h2>
    <p class="subtitle is-6"><%= event.date.strftime("%d.%m.%Y, %H:%M") %> | <%= event.place %></p>
    <p><strong>Cena biletu:</strong> <%= number_to_currency(ticket_batch.price, unit: "zł", format: "%n %u") %></p>
    <p><strong>Dostępne bilety:</strong> <%= ticket_batch.available_tickets %></p>
  </div>

  <%= form_with(model: order, url: orders_path(ticket_batch_id: ticket_batch.id), local: true) do |f| %>
    <% if order.errors.any? %>
      <div class="notification is-danger">
        <h2><%= pluralize(order.errors.count, "error") %> prohibited this order from being saved:</h2>
        <ul>
          <% order.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="field">
      <%= f.label :quantity, "Liczba biletów", class: "label" %>
      <div class="control">
        <%= f.number_field :quantity, min: 1, max: ticket_batch.available_tickets, value: 1, class: "input", data: { action: "change->order#updateTotal" } %>
      </div>
    </div>

    <div class="notification is-primary">
      <p><strong>Całkowita kwota do zapłaty:</strong> <span id="total-price"><%= number_to_currency(ticket_batch.price, unit: "zł", format: "%n %u") %></span></p>
    </div>

    <% unless user_signed_in? %>
      <div class="box">
        <h3 class="title is-5">Dane osobowe</h3>

        <div class="tabs">
          <ul>
            <li class="is-active"><a data-target="guest-tab">Zakup bez rejestracji</a></li>
            <li><a data-target="register-tab">Zarejestruj się</a></li>
            <li><a href="<%= new_user_session_path %>">Zaloguj się</a></li>
          </ul>
        </div>

        <div id="guest-tab" class="tab-content">
          <div class="field">
            <label class="label">Email</label>
            <div class="control">
              <input type="email" name="guest_email" class="input" required>
            </div>
          </div>

          <div class="field">
            <label class="label">Imię</label>
            <div class="control">
              <input type="text" name="guest_first_name" class="input" required>
            </div>
          </div>

          <div class="field">
            <label class="label">Nazwisko</label>
            <div class="control">
              <input type="text" name="guest_last_name" class="input" required>
            </div>
          </div>
        </div>

        <div id="register-tab" class="tab-content" style="display: none;">
          <input type="hidden" name="register" value="1">

          <div class="field">
            <label class="label">Email</label>
            <div class="control">
              <input type="email" name="user[email]" class="input">
            </div>
          </div>

          <div class="field">
            <label class="label">Imię</label>
            <div class="control">
              <input type="text" name="user[first_name]" class="input">
            </div>
          </div>

          <div class="field">
            <label class="label">Nazwisko</label>
            <div class="control">
              <input type="text" name="user[last_name]" class="input">
            </div>
          </div>

          <div class="field">
            <label class="label">Hasło</label>
            <div class="control">
              <input type="password" name="user[password]" class="input">
            </div>
          </div>

          <div class="field">
            <label class="label">Potwierdzenie hasła</label>
            <div class="control">
              <input type="password" name="user[password_confirmation]" class="input">
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <div class="field">
      <div class="control">
        <%= f.submit "Potwierdzam zakup", class: "button is-primary is-large" %>
      </div>
    </div>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.tabs a');
    tabs.forEach(tab => {
      tab.addEventListener('click', function(e) {
        e.preventDefault();

        tabs.forEach(t => t.parentElement.classList.remove('is-active'));
        this.parentElement.classList.add('is-active');

        const targetId = this.getAttribute('data-target');
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = 'none';
        });
        document.getElementById(targetId).style.display = 'block';
      });
    });

    const quantityInput = document.querySelector('input[name="order[quantity]"]');
    const totalPrice = document.getElementById('total-price');
    const unitPrice = <%= ticket_batch.price %>;

    quantityInput.addEventListener('change', function() {
      const quantity = parseInt(this.value);
      if (quantity > 0) {
        const price = (quantity * unitPrice).toFixed(2);
        totalPrice.textContent = price + ' zł';
      }
    });
  });
</script>
