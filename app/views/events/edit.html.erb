<div class="container mt-5">
  <div class="box">
    <h1 class="title is-3 has-text-primary">Edytuj wydarzenie</h1>
    <p class="subtitle is-5 has-text-grey">Zmień dane wydarzenia i zapisz</p>

    <%= form_with model: event, url: event_path(event), method: :patch, local: true, multipart: true do |form| %>
      <div class="field">
        <%= form.label :name, "Nazwa wydarzenia", class: "label" %>
        <div class="control">
          <%= form.text_field :name, class: "input", placeholder: "Wprowadź nazwę wydarzenia" %>
        </div>
      </div>

      <div class="field">
        <%= form.label :description, "Opis", class: "label" %>
        <div class="control">
          <%= form.text_area :description, class: "textarea", placeholder: "Wprowadź opis wydarzenia" %>
        </div>
      </div>

      <div class="field">
        <%= form.label :place, "Miejsce", class: "label" %>
        <div class="control">
          <%= form.text_field :place, class: "input", placeholder: "Wprowadź miejsce wydarzenia" %>
        </div>
      </div>

      <div class="field">
        <%= form.label :date, "Data i godzina", class: "label" %>
        <div class="control">
          <%= form.datetime_local_field :date, class: "input", min: DateTime.now.strftime('%Y-%m-%dT%H:%M'), value: event.date&.strftime('%Y-%m-%dT%H:%M') %>
        </div>
      </div>

      <div class="field">
        <%= form.label :category, "Kategoria", class: "label" %>
        <div class="control">
          <div class="select is-primary is-rounded">
            <%= form.select :category, Event.categories.keys.map { |key| [key.humanize, key] }, {}, {} %>
          </div>
        </div>
      </div>

      <div class="field">
        <%= form.label :image, "Obraz wydarzenia", class: "label" %>
        <div class="control">
          <% if event.image.attached? %>
            <div id="current-image-container" class="image-container mb-3" style="max-width: 300px;">
              <%= image_tag url_for(event.image), alt: event.name, class: "is-slightly-rounded", style: "width: 100%; height: auto;" %>
            </div>
          <% else %>
            <div id="current-image-container" class="image-container mb-3" style="max-width: 300px; display: none;">
              <img id="preview-image" class="is-slightly-rounded" style="width: 100%; height: auto;" alt="Podgląd obrazu">
            </div>
          <% end %>
          <p id="image-help" class="help mb-2"><%= event.image.attached? ? "Aktualne zdjęcie. Wybierz nowe, aby zmienić:" : "" %></p>

          <div class="file has-name" style="max-width: 400px;">
            <label class="file-label">
              <%= form.file_field :image, class: "file-input", direct_upload: true, accept: "image/*" %>
              <span class="file-cta">
                <span class="file-icon">
                  <i class="fas fa-upload"></i>
                </span>
                <span class="file-label">
                  Wybierz plik
                </span>
              </span>
              <span class="file-name" id="filename">
                Nie wybrano pliku
              </span>
            </label>
          </div>
        </div>
        <p class="help">Wybierz obraz dla wydarzenia. Wspierane formaty: JPG, PNG, GIF.</p>
      </div>

      <div class="buttons">
        <%= form.submit "Zapisz zmiany", class: "button is-primary" %>
        <%= link_to "Anuluj", events_path, class: "button is-light" %>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const fileInput = document.querySelector('.file-input');
  const fileName = document.querySelector('.file-name');
  const imageContainer = document.getElementById('current-image-container');
  const imageHelp = document.getElementById('image-help');

  let previewImage = imageContainer.querySelector('img');
  if (!previewImage) {
    previewImage = document.createElement('img');
    previewImage.id = 'preview-image';
    previewImage.className = 'is-slightly-rounded';
    previewImage.style = 'width: 100%; height: auto;';
    previewImage.alt = 'Podgląd obrazu';
    imageContainer.appendChild(previewImage);
  }

  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
      fileName.textContent = fileInput.files[0].name;

      const file = fileInput.files[0];
      const imageURL = URL.createObjectURL(file);

      previewImage.src = imageURL;

      imageContainer.style.display = 'block';
      imageHelp.textContent = 'Podgląd nowego zdjęcia (nie zapisane):';
    } else {
      fileName.textContent = 'Nie wybrano pliku';
      if (!<%= event.image.attached? %>) {
        imageContainer.style.display = 'none';
        imageHelp.textContent = '';
      } else {
        imageHelp.textContent = 'Aktualne zdjęcie. Wybierz nowe, aby zmienić:';
      }
    }
  });
});
</script>